<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM CONTROL - Salidas de Personal</title>
    <meta http-equiv="refresh" content="15"> 
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pantalla_personal.css') }}">
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='IMG/dm_logo.png') }}" alt="DM CONTROL" class="header-logo">
    </header>

    <div class="current-info">
        <span>{{ fecha_actual }}</span>
        <span>{{ hora_actual }}</span>
    </div>

    <div class="main-display">
        <div class="current-departure-container">
                {% if hora_activa_para_display_12h and fecha_activa_para_display %}
                <h2>Salidas Activas ({{ hora_activa_para_display_12h }} - {{ fecha_activa_para_display }})</h2>
            {% else %}
                <h2>Salidas Programadas Ahora</h2>
            {% endif %}

            {% if salidas_ahora_agrupadas_por_ruta %}
                <div class="current-departure-routes-wrapper">
                    <div class="current-routes-track" id="currentDepartureTrack">
                        {% for ruta_grupo_ahora in salidas_ahora_agrupadas_por_ruta %}
                            <div class="current-route-group">
                                <h4>{{ ruta_grupo_ahora.nombre_ruta }}</h4>
                                <ul class="current-time-list">
                                    {% for fecha_hora_grupo_ahora in ruta_grupo_ahora.grupos_por_fecha_hora %}
                                        <li>
                                            <strong>{{ fecha_hora_grupo_ahora.fecha }} - {{ fecha_hora_grupo_ahora.hora }}</strong>
                                            {% for salida in fecha_hora_grupo_ahora.salidas %}
                                                <div class="current-departure-item-card">
                                                    <span>{{ salida.recorrido }}</span>
                                                    <span>{{ salida.numero_camion_manual if salida.numero_camion_manual else 'Pendiente' }}</span>
                                                </div>
                                            {% endfor %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <p class="no-salida">No hay salidas activas en este momento</p>
            {% endif %}
        </div>

        <div class="next-departures">
            <h3>Próximas Salidas</h3>
            {% if proximas_salidas_agrupadas_por_ruta %}
                <div class="carousel-container">
                    <div class="carousel-track" id="carouselTrack">
                        {% for ruta_grupo in proximas_salidas_agrupadas_por_ruta %}
                            <div class="route-group">
                                <h4>{{ ruta_grupo.nombre_ruta }}</h4>
                                <ul class="time-list">
                                    {% for fecha_hora_grupo in ruta_grupo.grupos_por_fecha_hora %}
                                        <li>
                                            <strong>{{ fecha_hora_grupo.fecha }} - {{ fecha_hora_grupo.hora }}</strong>
                                            {% for salida in fecha_hora_grupo.salidas %}
                                                <div class="route-item-card">
                                                    <span>{{ salida.recorrido }}</span>
                                                    <span>{{ salida.numero_camion_manual if salida.numero_camion_manual else 'Pendiente' }}</span>
                                                </div>
                                            {% endfor %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="carousel-container" style="display: flex; justify-content: center; align-items: center;">
                    <p style="color: #ffffff; font-size: 1.8em; font-weight: 600;">No hay próximas salidas programadas</p>
                </div>
            {% endif %}
        </div>
    </div>

    <footer>
        Actualizado automáticamente cada 15 segundos
    </footer>

    <script>
        // --- Carrusel de Próximas Salidas (inferior) ---
        const carouselTrack = document.getElementById('carouselTrack');
        const carouselContainer = carouselTrack ? carouselTrack.parentElement : null;
        const routeGroups = carouselTrack ? carouselTrack.querySelectorAll('.route-group') : [];
        let currentIndex = 0;
        let intervalId;

        // --- Carrusel móvil optimizado ---
        function updateCarousel() {
            if (!carouselTrack || !carouselContainer || routeGroups.length === 0) {
                clearInterval(intervalId);
                intervalId = null;
                return;
            }

            // Ajustar número de elementos por página según el ancho de pantalla
            let itemsPerPage = 5;
            if (window.innerWidth <= 480) {
                itemsPerPage = 1; // 1 elemento en pantallas muy pequeñas
            } else if (window.innerWidth <= 768) {
                itemsPerPage = 2; // 2 elementos en tablets/móviles
            } else if (window.innerWidth <= 1200) {
                itemsPerPage = 4; // 4 elementos en pantallas medianas
            }

            const totalPages = Math.ceil(routeGroups.length / itemsPerPage);

            if (routeGroups.length > itemsPerPage) {
                const visiblePageWidth = carouselContainer.offsetWidth;
                const offset = -currentIndex * visiblePageWidth;
                
                carouselTrack.style.transform = `translateX(${offset}px)`;

                currentIndex++;
                if (currentIndex >= totalPages) {
                    currentIndex = 0;
                }
            } else {
                carouselTrack.style.transform = `translateX(0)`;
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        // Ajustar carrusel para móviles
        if (routeGroups.length > (window.innerWidth <= 768 ? 2 : 5)) {
            intervalId = setInterval(updateCarousel, 5000);
        }

        updateCarousel(); 

        // --- Scroll CSS automático  ---
        const currentDepartureTrack = document.getElementById('currentDepartureTrack');
        const MIN_ELEMENTS = 4;

        function setupCSSScroll() {
            if (!currentDepartureTrack) return;

            const routeGroups = currentDepartureTrack.querySelectorAll('.current-route-group');
            
            // Solo activar animación si hay 4+ elementos
            if (routeGroups.length >= MIN_ELEMENTS) {
                // Duplicar contenido para scroll infinito
                const originalContent = currentDepartureTrack.innerHTML;
                currentDepartureTrack.innerHTML = originalContent + originalContent;
                
                // Aplicar animación CSS
                currentDepartureTrack.style.animation = 'scroll-left 30s linear infinite';
            } else {
                // Sin animación para pocos elementos
                currentDepartureTrack.style.animation = 'none';
            }
        }

        // Inicializar
        setTimeout(setupCSSScroll, 1000);

        // --- Manejo de redimensionamiento de ventana ---
        window.addEventListener('resize', () => {
            // Reiniciar carrusel
            clearInterval(intervalId);
            intervalId = null;
            currentIndex = 0;
            updateCarousel();
            if (routeGroups.length > (window.innerWidth <= 768 ? 2 : 5)) {
                intervalId = setInterval(updateCarousel, 5000);
            }

            // Reiniciar scroll CSS
            setupCSSScroll();
        });
    </script>
</body>
</html>